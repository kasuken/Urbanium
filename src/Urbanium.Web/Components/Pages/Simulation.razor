@page "/simulation"
@inject WorldEngine WorldEngine
@inject MetricsService MetricsService
@implements IDisposable

<PageTitle>Simulation Control</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Simulation Control</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">Controls</MudText>
            
            <MudStack Row="true" Spacing="2" Class="mb-4">
                @if (!WorldEngine.IsRunning)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.PlayArrow" OnClick="Start">
                        Start
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Pause" OnClick="Stop">
                        Pause
                    </MudButton>
                }
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.SkipNext" OnClick="Step" Disabled="@WorldEngine.IsRunning">
                    Step
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.Refresh" OnClick="Reset">
                    Reset
                </MudButton>
            </MudStack>
            
            <MudDivider Class="my-4" />
            
            <MudText Typo="Typo.subtitle1" Class="mb-2">Tick Rate (ms)</MudText>
            <MudSlider @bind-Value="@_tickRate" Min="100" Max="2000" Step="100" Color="Color.Primary">
                @_tickRate ms per tick
            </MudSlider>
            
            <MudDivider Class="my-4" />
            
            <MudText Typo="Typo.subtitle1" Class="mb-2">Seed</MudText>
            <MudTextField @bind-Value="_seed" Label="Random Seed" Variant="Variant.Outlined" />
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">Current State</MudText>
            
            <MudSimpleTable Dense="true">
                <tbody>
                    <tr>
                        <td><strong>Status</strong></td>
                        <td>
                            @if (WorldEngine.IsRunning)
                            {
                                <MudChip T="string" Color="Color.Success" Size="Size.Small">Running</MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Color="Color.Default" Size="Size.Small">Stopped</MudChip>
                            }
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Current Tick</strong></td>
                        <td>@WorldEngine.State.CurrentTick</td>
                    </tr>
                    <tr>
                        <td><strong>Simulation Time</strong></td>
                        <td>@WorldEngine.State.Time.ToString("yyyy-MM-dd HH:mm")</td>
                    </tr>
                    <tr>
                        <td><strong>Seed</strong></td>
                        <td>@WorldEngine.State.Seed</td>
                    </tr>
                    <tr>
                        <td><strong>Working Hours</strong></td>
                        <td>@(WorldEngine.State.IsWorkingHours ? "Yes" : "No")</td>
                    </tr>
                    <tr>
                        <td><strong>Daytime</strong></td>
                        <td>@(WorldEngine.State.IsDaytime ? "Yes" : "No")</td>
                    </tr>
                </tbody>
            </MudSimpleTable>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudGrid Class="mt-4">
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">Event Log</MudText>
            <MudList T="string" Dense="true" Style="max-height: 300px; overflow-y: auto;">
                @foreach (var evt in _events.TakeLast(20).Reverse())
                {
                    <MudListItem>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@evt.Time.ToString("HH:mm:ss")</MudText>
                        <MudText>@evt.Message</MudText>
                    </MudListItem>
                }
            </MudList>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private int _tickRate = 1000;
    private int _seed = 42;
    private Timer? _timer;
    private List<(DateTime Time, string Message)> _events = new();
    
    protected override void OnInitialized()
    {
        WorldEngine.OnTick += OnTick;
        WorldEngine.OnEvent += OnEvent;
    }
    
    private void Start()
    {
        WorldEngine.TickRate = _tickRate;
        WorldEngine.Start();
        _timer = new Timer(TimerTick, null, 0, _tickRate);
        _events.Add((DateTime.Now, "Simulation started"));
    }
    
    private void Stop()
    {
        WorldEngine.Stop();
        _timer?.Dispose();
        _timer = null;
        _events.Add((DateTime.Now, "Simulation paused"));
        InvokeAsync(StateHasChanged);
    }
    
    private void Step()
    {
        WorldEngine.Tick();
        MetricsService.RecordMetrics(WorldEngine.State);
        _events.Add((DateTime.Now, $"Stepped to tick {WorldEngine.State.CurrentTick}"));
    }
    
    private void Reset()
    {
        Stop();
        WorldEngine.Reset(_seed);
        MetricsService.Clear();
        _events.Clear();
        _events.Add((DateTime.Now, $"Simulation reset with seed {_seed}"));
    }
    
    private void TimerTick(object? state)
    {
        if (WorldEngine.IsRunning)
        {
            WorldEngine.Tick();
            MetricsService.RecordMetrics(WorldEngine.State);
            InvokeAsync(StateHasChanged);
        }
    }
    
    private void OnTick(Engine.WorldState state)
    {
        InvokeAsync(StateHasChanged);
    }
    
    private void OnEvent(string message)
    {
        _events.Add((DateTime.Now, message));
        InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        _timer?.Dispose();
        WorldEngine.OnTick -= OnTick;
        WorldEngine.OnEvent -= OnEvent;
    }
}
