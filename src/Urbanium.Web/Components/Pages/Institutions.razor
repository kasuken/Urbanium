@page "/institutions"
@inject WorldEngine WorldEngine

<PageTitle>Institutions</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Institutions</MudText>
<MudText Typo="Typo.subtitle1" Class="mb-4" Color="Color.Secondary">
    Public services and institutions that serve the city population.
</MudText>

<MudGrid>
    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6">Public Services</MudText>
            <MudText Typo="Typo.h3" Color="Color.Primary">@WorldEngine.State.PublicServices.Count</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6">Public Employers</MudText>
            <MudText Typo="Typo.h3" Color="Color.Success">
                @WorldEngine.State.Employers.Count(e => e.Type == Engine.EmployerType.Public)
            </MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6">Non-Profit Orgs</MudText>
            <MudText Typo="Typo.h3" Color="Color.Secondary">
                @WorldEngine.State.Employers.Count(e => e.Type == Engine.EmployerType.NonProfit)
            </MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Class="pa-4 mt-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-4">Public Services</MudText>
    
    @if (WorldEngine.State.PublicServices.Count == 0)
    {
        <MudAlert Severity="Severity.Info">
            No public services defined. This feature can be extended in future versions.
        </MudAlert>
        
        <MudText Typo="Typo.body1" Class="mt-4">
            Planned public service types:
        </MudText>
        <MudList T="string" Dense="true">
            <MudListItem Icon="@Icons.Material.Filled.LocalHospital">Healthcare facilities</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.School">Educational institutions</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.DirectionsBus">Public transportation</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.LocalPolice">Emergency services</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.AccountBalance">Administrative offices</MudListItem>
        </MudList>
    }
    else
    {
        <MudDataGrid Items="@WorldEngine.State.PublicServices" Dense="true" Hover="true" Striped="true">
            <Columns>
                <PropertyColumn Property="x => x.Name" Title="Name" />
                <TemplateColumn Title="Type">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" Color="@GetServiceTypeColor(context.Item.Type)" 
                            Icon="@GetServiceTypeIcon(context.Item.Type)">
                            @context.Item.Type
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="District">
                    <CellTemplate>
                        @{
                            var district = WorldEngine.State.Geography.Districts
                                .FirstOrDefault(d => d.Id == context.Item.DistrictId);
                        }
                        @if (district != null)
                        {
                            <MudText>@district.Name</MudText>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.Capacity" Title="Capacity" />
                <TemplateColumn Title="Utilization">
                    <CellTemplate>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudProgressLinear Color="@GetUtilizationColor(context.Item.Utilization)" 
                                Value="@(context.Item.Utilization * 100)" Style="width: 100px;" />
                            <MudText Typo="Typo.caption">@context.Item.Utilization.ToString("P0")</MudText>
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</MudPaper>

<MudPaper Class="pa-4 mt-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-4">Public & Non-Profit Employers</MudText>
    
    @{
        var publicEmployers = WorldEngine.State.Employers
            .Where(e => e.Type == Engine.EmployerType.Public || e.Type == Engine.EmployerType.NonProfit)
            .ToList();
    }
    
    @if (publicEmployers.Count == 0)
    {
        <MudAlert Severity="Severity.Info">
            No public or non-profit employers in the simulation.
        </MudAlert>
    }
    else
    {
        <MudDataGrid Items="@publicEmployers" Dense="true" Hover="true">
            <Columns>
                <PropertyColumn Property="x => x.Name" Title="Name" />
                <TemplateColumn Title="Type">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" 
                            Color="@(context.Item.Type == Engine.EmployerType.Public ? Color.Success : Color.Secondary)">
                            @context.Item.Type
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="District">
                    <CellTemplate>
                        @{
                            var district = WorldEngine.State.Geography.Districts
                                .FirstOrDefault(d => d.Id == context.Item.DistrictId);
                        }
                        @if (district != null)
                        {
                            <MudText>@district.Name</MudText>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.EmployeeCount" Title="Employees" />
                <PropertyColumn Property="x => x.MaxEmployees" Title="Capacity" />
            </Columns>
        </MudDataGrid>
    }
</MudPaper>

@code {
    private Color GetServiceTypeColor(Engine.PublicServiceType type)
    {
        return type switch
        {
            Engine.PublicServiceType.Healthcare => Color.Error,
            Engine.PublicServiceType.Education => Color.Primary,
            Engine.PublicServiceType.PublicTransport => Color.Info,
            Engine.PublicServiceType.Emergency => Color.Warning,
            Engine.PublicServiceType.Administration => Color.Secondary,
            _ => Color.Default
        };
    }
    
    private string GetServiceTypeIcon(Engine.PublicServiceType type)
    {
        return type switch
        {
            Engine.PublicServiceType.Healthcare => Icons.Material.Filled.LocalHospital,
            Engine.PublicServiceType.Education => Icons.Material.Filled.School,
            Engine.PublicServiceType.PublicTransport => Icons.Material.Filled.DirectionsBus,
            Engine.PublicServiceType.Emergency => Icons.Material.Filled.LocalPolice,
            Engine.PublicServiceType.Administration => Icons.Material.Filled.AccountBalance,
            _ => Icons.Material.Filled.Business
        };
    }
    
    private Color GetUtilizationColor(double utilization)
    {
        if (utilization > 0.9) return Color.Error;
        if (utilization > 0.7) return Color.Warning;
        return Color.Success;
    }
}
