@page "/events"
@inject WorldEngine WorldEngine

<PageTitle>Events</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Simulation Events</MudText>
<MudText Typo="Typo.subtitle1" Class="mb-4" Color="Color.Secondary">
    Events that occur during simulation - tracked for analysis and debugging.
</MudText>

<MudGrid>
    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6">Total Events</MudText>
            <MudText Typo="Typo.h3" Color="Color.Primary">@WorldEngine.State.Events.Count</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6">Current Tick</MudText>
            <MudText Typo="Typo.h3" Color="Color.Secondary">@WorldEngine.State.CurrentTick</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6">Simulation Time</MudText>
            <MudText Typo="Typo.h3" Color="Color.Tertiary">@WorldEngine.State.Time.ToString("HH:mm")</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Class="pa-4 mt-4" Elevation="2">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h6">Event Log</MudText>
        <MudStack Row="true" Spacing="2">
            <MudTextField @bind-Value="_searchText" Label="Search" Variant="Variant.Outlined" 
                Margin="Margin.Dense" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />
            <MudSelect @bind-Value="_filterType" Label="Filter by Type" Variant="Variant.Outlined" Margin="Margin.Dense">
                <MudSelectItem Value="@("")">All Types</MudSelectItem>
                <MudSelectItem Value="@("Action")">Action</MudSelectItem>
                <MudSelectItem Value="@("Market")">Market</MudSelectItem>
                <MudSelectItem Value="@("System")">System</MudSelectItem>
            </MudSelect>
        </MudStack>
    </MudStack>
    
    @if (WorldEngine.State.Events.Count == 0)
    {
        <MudAlert Severity="Severity.Info">
            No events recorded yet. Start the simulation to begin logging events.
        </MudAlert>
    }
    else
    {
        <MudDataGrid Items="@GetFilteredEvents()" Dense="true" Hover="true" Striped="true">
            <Columns>
                <PropertyColumn Property="x => x.Tick" Title="Tick" />
                <PropertyColumn Property="x => x.Time" Title="Time" Format="HH:mm:ss" />
                <TemplateColumn Title="Type">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" Color="@GetEventTypeColor(context.Item.Type)">
                            @context.Item.Type
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.Description" Title="Description" />
                <TemplateColumn Title="Data">
                    <CellTemplate>
                        @if (context.Item.Data.Any())
                        {
                            <MudTooltip>
                                <ChildContent>
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Info" />
                                </ChildContent>
                                <TooltipContent>
                                    @foreach (var kv in context.Item.Data)
                                    {
                                        <MudText Typo="Typo.caption">@kv.Key: @kv.Value</MudText>
                                    }
                                </TooltipContent>
                            </MudTooltip>
                        }
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</MudPaper>

@code {
    private string _searchText = "";
    private string _filterType = "";
    
    private IEnumerable<Engine.SimulationEvent> GetFilteredEvents()
    {
        var events = WorldEngine.State.Events.AsEnumerable().Reverse();
        
        if (!string.IsNullOrEmpty(_filterType))
        {
            events = events.Where(e => e.Type.Contains(_filterType, StringComparison.OrdinalIgnoreCase));
        }
        
        if (!string.IsNullOrEmpty(_searchText))
        {
            events = events.Where(e => 
                e.Description.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                e.Type.Contains(_searchText, StringComparison.OrdinalIgnoreCase));
        }
        
        return events.Take(100);
    }
    
    private Color GetEventTypeColor(string type)
    {
        return type.ToLower() switch
        {
            "action" => Color.Primary,
            "market" => Color.Success,
            "system" => Color.Warning,
            "error" => Color.Error,
            _ => Color.Default
        };
    }
}
