@page "/labor-market"
@inject WorldEngine WorldEngine

<PageTitle>Labor Market</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Labor Market</MudText>
<MudText Typo="Typo.subtitle1" Class="mb-4" Color="Color.Secondary">
    Job listings, employment relationships, and workforce dynamics.
</MudText>

<MudGrid>
    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6">Open Positions</MudText>
            <MudText Typo="Typo.h3" Color="Color.Primary">@WorldEngine.State.LaborMarket.OpenPositions.Count</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6">Employed</MudText>
            <MudText Typo="Typo.h3" Color="Color.Success">@WorldEngine.State.Citizens.Count(c => c.EmployerId.HasValue)</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6">Unemployed</MudText>
            <MudText Typo="Typo.h3" Color="Color.Warning">@WorldEngine.State.Citizens.Count(c => !c.EmployerId.HasValue)</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6">Employment Rate</MudText>
            <MudText Typo="Typo.h3" Color="Color.Secondary">
                @{
                    var total = WorldEngine.State.Citizens.Count;
                    var employed = WorldEngine.State.Citizens.Count(c => c.EmployerId.HasValue);
                    var rate = total > 0 ? (double)employed / total : 0;
                }
                @rate.ToString("P0")
            </MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Class="pa-4 mt-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-4">Available Positions</MudText>
    
    @if (WorldEngine.State.LaborMarket.OpenPositions.Count == 0)
    {
        <MudAlert Severity="Severity.Info">
            No open positions available. All jobs are filled or no employers exist.
        </MudAlert>
    }
    else
    {
        <MudDataGrid Items="@WorldEngine.State.LaborMarket.OpenPositions" Dense="true" Hover="true" Striped="true">
            <Columns>
                <PropertyColumn Property="x => x.Title" Title="Position" />
                <PropertyColumn Property="x => x.Wage" Title="Monthly Wage" Format="C0" />
                <TemplateColumn Title="Employer">
                    <CellTemplate>
                        @{
                            var employer = WorldEngine.State.Employers.FirstOrDefault(e => e.Id == context.Item.EmployerId);
                        }
                        @if (employer != null)
                        {
                            <MudText>@employer.Name</MudText>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Location">
                    <CellTemplate>
                        @{
                            var district = WorldEngine.State.Geography.Districts
                                .FirstOrDefault(d => d.Id == context.Item.LocationDistrictId);
                        }
                        @if (district != null)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@district.Name</MudChip>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Required Skills">
                    <CellTemplate>
                        @if (context.Item.RequiredSkills.Any())
                        {
                            @foreach (var skill in context.Item.RequiredSkills)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Default">@skill</MudChip>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">No requirements</MudText>
                        }
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</MudPaper>

<MudPaper Class="pa-4 mt-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-4">Employment by Employer</MudText>
    
    @if (WorldEngine.State.Employers.Count == 0)
    {
        <MudAlert Severity="Severity.Info">No employers in the simulation.</MudAlert>
    }
    else
    {
        <MudDataGrid Items="@GetEmployerStats()" Dense="true" Hover="true">
            <Columns>
                <PropertyColumn Property="x => x.Name" Title="Employer" />
                <PropertyColumn Property="x => x.Type" Title="Type" />
                <PropertyColumn Property="x => x.EmployeeCount" Title="Employees" />
                <PropertyColumn Property="x => x.OpenPositions" Title="Open Positions" />
                <TemplateColumn Title="Capacity">
                    <CellTemplate>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudProgressLinear Color="Color.Primary" 
                                Value="@(context.Item.MaxEmployees > 0 ? (double)context.Item.EmployeeCount / context.Item.MaxEmployees * 100 : 0)" 
                                Style="width: 100px;" />
                            <MudText Typo="Typo.caption">@context.Item.EmployeeCount / @context.Item.MaxEmployees</MudText>
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</MudPaper>

@code {
    private List<EmployerStats> GetEmployerStats()
    {
        return WorldEngine.State.Employers.Select(e => new EmployerStats
        {
            Name = e.Name,
            Type = e.Type.ToString(),
            EmployeeCount = WorldEngine.State.Citizens.Count(c => c.EmployerId == e.Id),
            MaxEmployees = e.MaxEmployees,
            OpenPositions = WorldEngine.State.LaborMarket.OpenPositions.Count(j => j.EmployerId == e.Id)
        }).ToList();
    }
    
    private class EmployerStats
    {
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";
        public int EmployeeCount { get; set; }
        public int MaxEmployees { get; set; }
        public int OpenPositions { get; set; }
    }
}
